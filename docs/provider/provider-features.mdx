---
sidebar_position: 2
slug: /provider-features
title: 功能
---

# 提供商功能 🧰

本页面详细介绍了Lava网络中提供的各种功能，以及如何操作它们的说明:

- [💰 Rewards Tracking](#rewards-tracking)
- [⚡ Caching](#caching)
- [🔌 Addons and Extensions](#addonsextensions)
- [🧊 Freeze and Unfreeze](#freeze)
- [🔐 Advanced Auth Configuration](#config-auth)
- [⏩ `ip-forwarding` Configuration](#config-ip-forwarding)
- [⌛ `node-timeout` Configuration](#config-node-timeout)
- [⚖️ Load Balancer Configuration](#config-stickyness)
- [📈 Prometheus Metrics Configuration](#config-prometheus)

--- 

## 💰 奖励追踪{#rewards-tracking}

一旦提供商启动并运行，消费者将向提供商请求中继服务。一旦提供商提供服务，他们将有资格从他们所服务的消费者那里获得奖励。当消费者的月度计划到期时，提供商可以获得奖励。

提供商可以通过以下查询查询来查询他们将收到的估计金额：

```bash
lavad q pairing provider-monthly-payout <lava-provider-address> 
```

可领取的奖励可以通过以下方式查询：

```bash
lavad q dualstaking delegator-rewards <lava-provider-address>
```

并且可以通过以下方式向提供商余额认领：

```bash
lavad tx dualstaking claim-rewards --from <provider-key>
```

<br />

## ⚡ 缓存{#caching}

Lava 的缓存服务用于降低成本并提高网络的整体性能。提供者和使用者进程都受益于缓存服务。启用缓存的提供程序可能比未启用缓存的提供程序更快地返回响应。

要使用缓存服务，请运行以下命令：

```
ListenAddress="127.0.0.1:7777"
ListenMetricsAddress="127.0.0.1:5747"
lavap cache $ListenAddress --metrics_address $ListenMetricsAddress --log_level debug
```

缓存服务将在后台运行。根据情况将缓存服务插入消费者或提供者进程：

<details> <summary> rpcprovider </summary>

```
lavap rpcprovider <your-regular-cli-options> --cache-be $ListenAddress
```
</details>

<details> <summary> rpcconsumer </summary>

```
lavap rpcconsumer <your-regular-cli-options> --cache-be $ListenAddress
```

</details>

<br/>

## 🔌 插件和扩展{#addonsextensions}

插件和扩展是除了提供程序服务的基本规范之外还可以提供的服务。插件是除了现有 API 之外公开的 API，而扩展是对现有 API 响应的更改。

举几个例子：
- `"archive"` - 一个扩展，为比基本规范中当前修剪定义更旧的块提供有效的响应
- `"debug" `- 除了基本的 RPC 调用之外，还提供调试 API 的插件

### 为什么选择插件和扩展程序 ❔

服务插件和扩展程序是为您的端点带来额外流量和更高奖励的好方法。

#### ⛗ 其他流量

消费者无需任何客户端配置即可轻松使用插件和扩展程序。它们包含在使用者订阅中。Lava 协议会自动将请求路由到支持所需服务的提供商，这可能会导致支持特定插件的提供商的流量增加，而不支持的提供商将不会收到此类请求。

#### 💱 更高的奖励

扩展还可以在常规 API 上提供 CU 提升，这意味着修改后的调用可能会获得更高的奖励。`"archive"` 例如，对于每个 API 请求，调用在 CU 上都会有一个很大的乘数。只有对端点的 `"archive"` API 请求才会授予这些额外的 CU，并且 Lava 根据治理定义的常规规范的修剪知道哪些调用是`"archive"` 或不是。

### 设置插件和扩展程序 ⚙️

插件和扩展在提供者服务配置中配置，然后在链上质押。💡 为简单起见，插件和扩展都是使用该`addons:`字段定义的。有关参考，请参阅此[示例](https://raw.githubusercontent.com/lavanet/lava/main/config/provider_examples/evmos_provider_with_archive.yml)提供程序配置文件。


#### 🗒️ 插件 （配置文件）

为了将插件添加到服务中，必须使用 addon 命令配置 yaml：

```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address:
        address: "127.0.0.1:2224"
      node-urls:
        - url: my-eth-node.com/eth-with-debug/ws
          // highlight-start
          addons:
            - debug
          // highlight-end
```

#### 🗒️ 扩展名 （配置文件）

由于扩展必须为消费者提供常规规范功能和扩展功能的可能性，因此两者都必须存在。

因此，与插件不同的扩展必须在新的 url 条目中配置：

```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address:
        address: "127.0.0.1:2224"
      node-urls:
        - url: my-eth-node.com/eth/ws/ # must keep this line
        // highlight-start
        - url: my-eth-node.com/eth-with-archive/ws
          addons:
            - archive
        // highlight-end
```


尽管此配置为您提供了对不同扩展调用进行负载均衡的机会，但如果您只运行单个存档节点，并且不希望自动对已修剪的节点的存档调用进行负载均衡，则可以将两个 URL 设置为指向存档节点：

```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address:
        address: "127.0.0.1:2224"
      node-urls:
      // highlight-start
        - url: my-eth-node.com/eth-with-archive/ws
        - url: my-eth-node.com/eth-with-archive/ws
          addons:
            - archive
      // highlight-end
```

#### 🗒️ 多个扩展名（配置文件）

必须使用所有可能的组合定义其他扩展，例如，合规性 + 存档将如下所示：



```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address:
        address: "127.0.0.1:2224"
      node-urls:
        - url: my-eth-node.com/eth/ws/
        // highlight-start
        - url: my-eth-node.com/eth-with-archive/ws
          addons:
            - archive
        - url: my-eth-node.com/eth-with-compliance/ws
          addons:
            - compliance
        - url: my-eth-node.com/eth-with-compliance-and-archive/ws
          addons:
            - compliance
            - archive
        // highlight-end
```

#### 🗒️ 组合（配置文件）

扩展和插件的组合如下所示：
```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address:
        address: "127.0.0.1:2224"
      node-urls:
        - url: my-eth-node.com/eth/ws/archive
          addons:
            - archive
        - url: my-eth-node.com/eth-with-debug/ws
          addons:
            - debug
```

#### ⛏️ 质押

在质押之前，请确保您的进程正常运行。如果插件或扩展无法验证，则该规范和 api 接口的整个服务将失败。请使用该 lavap test rpcprovider 命令验证您的设置是否正确。

使用插件或扩展进行质押与普通的质押命令非常相似。只需通过添加以逗号分隔的插件和扩展列表来修改它：

**质押示例：`stake-provider` ⌨️ **

在美国地区的以太坊主网，具有存档和调试功能

```bash
lavap tx pairing stake-provider "ETH1" \
    "50000000000ulava" \
    "provider-host.com:443,USC,archive,debug" USC \
    --from "my_account_name" \
    --provider-moniker "your-moniker" \
    --keyring-backend "test" \
    --chain-id "lava-testnet-2" \
    --gas="auto" \
    --gas-adjustment "1.5" \
    --node "https://public-rpc-testnet2.lavanet.xyz:443/rpc/"
```
请注意，如果存在多个端点，则需要**`，archive,debug`**在支持它的每个端点中添加 。在事务中设置这些终结点会替换任何现有终结点，因此请确保提供终结点的完整列表。


** 质押示例： `modify-provider` ⌨️ **

也可以使用以下`modify-provider`命令将这些添加到现有条目中：


```bash
lavap tx pairing modify-provider "ETH1" --endpoints "provider-host.com:443,USC,archive,debug" --geolocation "USC" ...
```

<br/>

## 🧊 冻结和解冻{#freeze}

该**`freeze`**命令允许提供者冻结其服务，在下一个纪元生效。这使提供商能够暂停其服务，而不会受到不良 QoS 评级的影响。冻结时，提供商不会与使用者配对。要解冻，提供商必须使用**`unfreeze`**交易，在下一个纪元生效。此功能在提供商需要在维护期间停止其服务等情况下非常有用。

### 使用 🔨

#### ❄️ 冻结:

```bash
# required flags: --from alice. optional flags: --reason
lavap tx pairing freeze [chain-ids] --from <provider_address>
lavap tx pairing freeze [chain-ids] --from <provider_address> --reason <freeze_reason>
lavap tx pairing freeze ETH1,COS3 --from alice --reason "maintenance"
```

该**`freeze`**命令需要该**`--from`**标志来指定提供程序地址。（可选）您可以提供一个**`--reason`**标志来说明冻结的原因。

#### 🌡️ 解冻：

```bash
# required flags: --from alice
lavap tx pairing unfreeze [chain-ids] --from <provider_address>
lavap tx pairing unfreeze ETH1,COS3 --from alice
```
该**`unfreeze`**命令还需要该**`--from`**标志来指定提供程序地址。


<br />

## 🔐 高级身份验证配置 {#config-auth}
在此示例中，假设节点 URL 能够处理此身份验证，则 COS3 tendermint URL 使用客户端身份验证。

### 使用 HTTP 标头进行身份验证 🔑 {#auth-headers}

以下 RPCProvider 配置示例演示了使用“auth-headers”选项进行身份验证：


```yaml
endpoints:
  - api-interface: tendermintrpc
    chain-id: COS3
    network-address: 
     address: 127.0.0.1:2221
    node-urls:
      - url: ws://127.0.0.1:26657/websocket
        auth-config:
          auth-headers:
            WANTED_HEADER_NAME_1: xyz
      - url: http://127.0.0.1:26657
        auth-config:
        // highlight-start
          auth-headers:strings.Join(goodChains, "; ")
            Authorization: 'Bearer xxyyzz'
        // highlight-end
```

### 使用查询参数进行身份验证 🔑 {#auth-query}

以下 RPCProvider 配置示例演示了使用“auth-query”选项进行身份验证：

```yaml
endpoints:
    - api-interface: tendermintrpc
      chain-id: COS3
      network-address: 
        address: 127.0.0.1:2221
      node-urls:
        - url: ws://127.0.0.1:26657/websocket
          // highlight-start
          auth-config:
            auth-query: auth=xxyyzz
          // highlight-end
        - url: http://127.0.0.1:26657
          auth-config:
            auth-query: auth=xyz
```

### gRPC TLS 配置 🔑 {#grpc-tls}

如果要将 TLS 身份验证添加到 gRPC 端点，则有 3 个选项：

#### 1. 动态证书

```yaml
endpoints:
    - api-interface: grpc
      chain-id: LAV1
      network-address: 
        address: 127.0.0.1:2221
      node-urls:
        - url: 127.0.0.1:9090
          // highlight-start
          auth-config:
            use-tls: true 
          // highlight-end
```

#### 2. 提供证书和密钥：

```yaml
endpoints:
    - api-interface: grpc
      chain-id: LAV1
      network-address: 
        address: 127.0.0.1:2221
      node-urls:
        - url: 127.0.0.1:9090
          // highlight-start
          auth-config:
            use-tls: true
            key-pem: /home/user/key.pem
            cert-pem: /home/user/cert.pem
          // highlight-end
```

#### 3. 提供根证书：

```yaml
endpoints:
    - api-interface: grpc
      chain-id: LAV1
      network-address: 
        address: 127.0.0.1:2221
      node-urls:
        - url: 127.0.0.1:9090
          // highlight-start
          auth-config:
            use-tls: true
            cacert-pem: /home/user/cert.pem 
          // highlight-end
```

<br />

## ⏩ `ip-forwarding` 配置 {#config-ip-forwarding}

如果要进行 IP 负载均衡/限制，也可以通过添加：`ip-forwarding: true`。
 将该 IP 添加到以下标头： `X-Forwarded-For`。

```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address: 
        address: 127.0.0.1:2221
      node-urls: 
        - url: ws://your_node_url/
          // highlight-start
          ip-forwarding: true
          // highlight-end
```

<br />

## ⌛ `node-timeout` 配置 {#config-node-timeout}

:::caution
覆盖超时时间可能会导致使用者的 QoS 较差。
:::
如果您的节点离`rpcprovider`太远或响应速度太慢，并且您仍然希望提供商程序进程在不进行故障排除的情况下启动，则可以使用 node-urls 配置中的标志使用自定义值覆盖超时：

```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address: 
        address: 127.0.0.1:2221
      node-urls: 
        - url: ws://your_node_url/
          // highlight-start
          timeout: 1s
          // highlight-end
```
<br />

## ⚖️ 负载均衡器配置 {#config-stickyness}

使用负载均衡器运行多个节点可以有多个设置：
1. **在每个节点上运行一个提供者** - 如果在提供者进程之前负载均衡 gRPC，并在每个节点机器上运行一个提供者服务（距离较近），那么提供者进程可以共存。
2. **运行一个提供者服务并对节点进行负载均衡 **- 在这种情况下，所有节点都由一个提供者服务使用，这种设置更有可能触发提供者服务和节点之间的一致性问题。

### 为负载均衡节点设置stickyness支持 🍯

如果您设置了第二个选项，即每个多个节点一个提供者服务，则需要通过一个标头在节点之间提供stickyness。原因是提供者签署的加密证明必须一致，不能让区块的进度倒退。

为了支持stickyness标头，Lava 默认添加了一个名为 `X-Node-Sticky` 的标头，该标头添加了一个由多个因素组成且对每个消费者使用唯一的消费者令牌。

### 更改Stickyness标头 🔀

为了支持现有的负载均衡器配置，可以使用配置中的配置来更改标头名称：
```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address: 
        address: 127.0.0.1:2221
      node-urls: 
        - url: ws://your_node_url/
// highlight-start
sticky-header: <your-sticky-header-name>
// highlight-end
```

<br />

## 📈 Prometheus 指标配置 {#config-prometheus}

添加对 prometheus 的支持是一个简单的更改。设置以下内容`metrics-listening-address:`。请注意，所有 Lava 分析都以`lava_`开头。更改以下配置：


```yaml
endpoints:
    - api-interface: jsonrpc
      chain-id: ETH1
      network-address: 
        address: 127.0.0.1:2221
      node-urls: 
        - url: ws://your_node_url/
// highlight-start
metrics-listen-address: ":7780"
// highlight-end
```
